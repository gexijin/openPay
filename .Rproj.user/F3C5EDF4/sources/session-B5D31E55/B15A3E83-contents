library(ggplot2)
library(plotly)
library(tidyverse)
library(sf) ## Overall handling of sf objects
library(cartography) ## Plotting maps package
library(tigris) ## For downloading the zipcode map

# Define server logic required to draw a histogram
server <- function(input, output, session) {



  ## Text Outputs
  output$txtOutput <- renderText({
    paste0("Open Payments: Payments that drug & medical device companies 
           make to covered recipients (physicians, nurses, etc). ")
  })
  output$txtOutput2 <- renderText({
    paste0("Nature of Payments: Categories describing what form or type 
           of payment was made.")
  })
  output$txtOutput3 <- renderText({
    paste0("Amount: For each zipcode, a cumulative total of the dollar amount
           from every payment over the years 2013-18.")
  })
  output$txtOutput4 <- renderText({
    paste0("List of countries, except the US, who made payments.")
  })
  




  ## 'Select City' Output
  output$city <- renderUI({
    selectInput("city", "Select City", choices = cities)
  })




  ## Plot Outputs
  output$donut_plot <- renderPlotly({
    
    # this solves the error when starting up.
    # if this input is not available, do not try to generate the plot
    req(input$city) 
    
    ## using input for city
    donutdata <- filter(payment, recipient_city == input$city)

    ## create dataframe
    donutdata2 <- data.frame(
      cat = levels(donutdata$nature.of.payment),
      count = tapply(
        donutdata$nature.of.payment, donutdata$nature.of.payment,
        length
      )
    )
    donutdata3 <- donutdata2 %>% drop_na(count)

    ## compute ymax and ymin
    donutdata3$fraction <- donutdata3$count / sum(donutdata3$count)
    donutdata3$ymax <- cumsum(donutdata3$fraction)
    donutdata3$ymin <- c(0, head(donutdata3$ymax, n = -1))

    ## change font
    t <- list(family = "Arial", size = 16, color = "black")

    ## plotting
    donutdata3 <- donutdata3 %>% group_by(cat)
    fig <- donutdata3 %>%
      plot_ly(
        labels = ~cat, values = ~fraction,
        insidetextorientation = "radial"
      ) %>%
      add_pie(hole = 0.6) %>%
      layout(
        showlegend = T,
        legend = list(title = list(text = "Type:", font = t))
      )
  })




  output$sd_map <- renderPlot({

    ## create dataframe
    yourdata <- data.frame(
      ZCTA5CE10 = mapdata$zippy,
      Amount = mapdata$total_amount_of_payment_usdollars
    )

    ## download a shapefile (shp,gpkg,geojson...)
    options(tigris_use_cache = TRUE)
    geo <- st_as_sf(zctas(cb = FALSE, state = "South Dakota", year = 2010))

    ## overall shape of the state
    state <- st_as_sf(zctas(cb = FALSE, state = "South Dakota", year = 2010))
    state <- st_transform(state, st_crs(geo))

    ## merge the data
    yourdata.sf <- merge(geo, yourdata)

    ## plotting
    par(mar = c(1, 1, 1, 1))
    ghostLayer(yourdata.sf)
    plot(st_geometry(state), add = TRUE, border = "gray")
    choroLayer(yourdata.sf,
      var = "Amount",
      add = TRUE,
      border = NA,
      legend.pos = "n"
    )
    legendChoro(
      pos = "bottomleft", title.txt = "Amount",
      title.cex = 1.8, values.cex = 1.35, cex = 1.1,
      breaks = c(
        "$15", "$30", "$100", "$250", "$750", "$2,000",
        "$6,200", "$53,000", "$7,140,000"
      ),
      col = carto.pal(pal1 = "blue.pal", n1 = 8)
    )
  })
  
  
  
  
  
  output$country <- renderPlot({
    ggplot(df2, aes(x = input$predictors, fill = 'Applicable Manufacturer/GOP Making Payment Country')) +
      geom_bar()
    # +
      # theme(axis.title.y = element_blank(),
      #       axis.text.y = element_blank(), 
      #       axis.ticks.y = element_blank(),
      #       axis.title.x = element_blank(),
      #       axis.text.x = element_text(size = 18),
      #       legend.text = element_text(size = 20),
      #       legend.title = element_text(size = 17))
    
  })
}
